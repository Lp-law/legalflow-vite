import os
import codecs

# הנתיב המבוקש
base_path = r"C:\Users\lior\OneDrive\שולחן העבודה\Cash flow software"

def create_file(path, content):
    full_path = os.path.join(base_path, path)
    os.makedirs(os.path.dirname(full_path), exist_ok=True)
    with codecs.open(full_path, "w", "utf-8") as f:
        f.write(content)
    print(f"Created: {path}")

# --- FILE CONTENT DEFINITIONS ---

index_html = r"""<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LegalFlow - ניהול תזרים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Assistant', sans-serif;
        background-color: #f8fafc;
      }
      h1, h2, h3, h4, h5, h6 {
        font-family: 'Heebo', sans-serif;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="./index.tsx"></script>
  </body>
</html>"""

index_tsx = r"""import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);"""

metadata_json = r"""{
  "name": "LegalFlow - ניהול תזרים למשרד עורכי דין",
  "description": "מערכת מתקדמת לניהול תזרים מזומנים למשרדי עורכי דין, עם דגש על תובנות פיננסיות, ניתוח נתונים ויזואלי וממשק משתמש יוקרתי.",
  "requestFramePermissions": []
}"""

types_ts = r"""export type TransactionType = 'income' | 'expense';

// Updated groups to support split income columns
export type TransactionGroup = 'fee' | 'other_income' | 'operational' | 'tax' | 'loan' | 'personal';

export interface Transaction {
  id: string;
  date: string; // ISO date string YYYY-MM-DD
  amount: number;
  type: TransactionType;
  group: TransactionGroup; 
  category: string;
  description: string;
  clientReference?: string; // Optional: Reference to a specific case or client file
  paymentMethod: 'transfer' | 'check' | 'credit_card' | 'cash';
  status: 'pending' | 'completed';
  isRecurring?: boolean; 
  
  // New fields for Auto-Tax Logic
  isAutoGenerated?: boolean; // True if created by the system (Tax/VAT)
  linkedMonth?: string; // YYYY-MM : The month this tax payment relates to (e.g. Tax in Feb relates to Jan income)
  isManualOverride?: boolean; // If true, the auto-calculator won't update the amount automatically
}

export interface MonthlySummary {
  totalIncome: number;
  totalExpenses: number;
  netCashFlow: number;
  startBalance: number;
  endBalance: number;
}

export interface Category {
  id: string;
  name: string;
  type: TransactionType;
  group: TransactionGroup;
  color: string;
  defaultAmount?: number; // Optional default amount for auto-fill
  defaultDay?: number;    // Optional default day of month (1-31)
}"""

constants_ts = r"""import { Category, Transaction } from './types';

export const CATEGORIES: Category[] = [
  // 1. Fee Column (Only one implicit category really, but we define it for consistency)
  { id: 'inc_fee', name: 'שכר טרחה', type: 'income', group: 'fee', color: '#10b981' },

  // 2. Other Income Column
  { id: 'inc_other_1', name: 'החזר הוצאות', type: 'income', group: 'other_income', color: '#34d399' },
  { id: 'inc_other_2', name: 'זיכוי', type: 'income', group: 'other_income', color: '#6ee7b7' },
  { id: 'inc_other_3', name: 'החזר מס', type: 'income', group: 'other_income', color: '#a7f3d0' },
  
  // Operational Expenses
  { id: 'e1', name: 'משכורות', type: 'expense', group: 'operational', color: '#dc2626' },
  { id: 'e2', name: 'פנסיות עובדים', type: 'expense', group: 'operational', color: '#b91c1c' },
  { id: 'e3', name: 'קה"ש ליאור', type: 'expense', group: 'operational', color: '#f87171' },
  { id: 'e4', name: 'ריג\'וס', type: 'expense', group: 'operational', color: '#fbbf24' }, // Regus
  { id: 'e5', name: 'גט טקסי', type: 'expense', group: 'operational', color: '#fb923c' },
  { id: 'e6', name: 'ביטוח עסק', type: 'expense', group: 'operational', color: '#fca5a5' },
  { id: 'e7', name: 'כרטיס אשראי', type: 'expense', group: 'operational', color: '#94a3b8' },
  { id: 'e8', name: 'חשבת שכר', type: 'expense', group: 'operational', color: '#ec4899' },
  { id: 'e9', name: 'רישיונות עו"ד', type: 'expense', group: 'operational', color: '#6366f1' },
  { id: 'e10', name: 'ביטוח א. מקצועית', type: 'expense', group: 'operational', color: '#818cf8' },
  { id: 'e11', name: 'פנסיה ליאור', type: 'expense', group: 'operational', color: '#ef4444' },
  { id: 'e12', name: 'אשראי עסקי', type: 'expense', group: 'operational', color: '#cbd5e1' },
  { id: 'e13', name: 'ספיקן', type: 'expense', group: 'operational', color: '#2dd4bf' },
  { id: 'e14', name: 'שכ"ט רו"ח', type: 'expense', group: 'operational', color: '#0d9488' },

  // Taxes
  { id: 't1', name: 'מע"מ', type: 'expense', group: 'tax', color: '#7f1d1d' },
  { id: 't2', name: 'מס הכנסה עובדים', type: 'expense', group: 'tax', color: '#991b1b' },
  { id: 't3', name: 'מס הכנסה אישי', type: 'expense', group: 'tax', color: '#b91c1c' },
  { id: 't4', name: 'ביטוח לאומי עובדים', type: 'expense', group: 'tax', color: '#ef4444' },
  { id: 't5', name: 'ביטוח לאומי אישי', type: 'expense', group: 'tax', color: '#f87171' },
  
  // Loans
  { id: 'l1', name: 'מימון ישיר', type: 'expense', group: 'loan', color: '#ea580c', defaultAmount: 1868, defaultDay: 2 },
  { id: 'l2', name: 'פועלים', type: 'expense', group: 'loan', color: '#c2410c', defaultAmount: 2990, defaultDay: 20 },
  { id: 'l3', name: 'משכנתא', type: 'expense', group: 'loan', color: '#9a3412', defaultAmount: 5400, defaultDay: 15 },

  // Personal
  { id: 'w1', name: 'משיכה פרטית', type: 'expense', group: 'personal', color: '#a855f7' },
  { id: 'w2', name: 'הוצאות רכב פרטי', type: 'expense', group: 'personal', color: '#9333ea' },
  { id: 'w3', name: 'הוצאות בית', type: 'expense', group: 'personal', color: '#7e22ce' },
];

export const INITIAL_CLIENTS = [
  "שור",
  "טרם",
  "לוידס",
  "פלג אורייון",
  "טר ארמה",
  "מ.א.ר",
  "מד\"א",
  "היימן"
];

export const PAYMENT_METHODS = [
  { value: 'transfer', label: 'העברה בנקאית' },
  { value: 'check', label: 'המחאה (צ׳ק)' },
  { value: 'credit_card', label: 'כרטיס אשראי' },
  { value: 'cash', label: 'מזומן' },
];

export const INITIAL_TRANSACTIONS: Transaction[] = [];
export const INITIAL_BALANCE = 0;"""

storage_service_ts = r"""import { Transaction } from '../types';
import { INITIAL_TRANSACTIONS, INITIAL_BALANCE, CATEGORIES, INITIAL_CLIENTS } from '../constants';

const STORAGE_KEY_TRANSACTIONS = 'legalflow_transactions_v2';
const STORAGE_KEY_INITIAL_BALANCE = 'legalflow_initial_balance_v2';
const STORAGE_KEY_CUSTOM_CATEGORIES = 'legalflow_custom_categories_v2';
const STORAGE_KEY_CLIENTS = 'legalflow_clients_v1';

export const getTransactions = (): Transaction[] => {
  const stored = localStorage.getItem(STORAGE_KEY_TRANSACTIONS);
  if (stored) {
    return JSON.parse(stored);
  }
  return INITIAL_TRANSACTIONS;
};

export const saveTransactions = (transactions: Transaction[]) => {
  localStorage.setItem(STORAGE_KEY_TRANSACTIONS, JSON.stringify(transactions));
};

export const getInitialBalance = (): number => {
  const stored = localStorage.getItem(STORAGE_KEY_INITIAL_BALANCE);
  if (stored) {
    return parseFloat(stored);
  }
  return INITIAL_BALANCE;
};

export const saveInitialBalance = (amount: number) => {
  localStorage.setItem(STORAGE_KEY_INITIAL_BALANCE, amount.toString());
};

// --- Custom Categories Logic ---

export const getCustomCategories = () => {
    const stored = localStorage.getItem(STORAGE_KEY_CUSTOM_CATEGORIES);
    if (stored) {
        return JSON.parse(stored);
    }
    return [];
};

export const saveCustomCategory = (newCategoryName: string, type: 'income' | 'expense', specificGroup?: string) => {
    const current = getCustomCategories();
    
    let group = type === 'income' ? 'other_income' : 'operational'; // Default for new custom
    if (specificGroup) group = specificGroup;

    const newCat = {
        id: `custom_${Date.now()}`,
        name: newCategoryName,
        type: type,
        group: group,
        color: '#64748b'
    };
    const updated = [...current, newCat];
    localStorage.setItem(STORAGE_KEY_CUSTOM_CATEGORIES, JSON.stringify(updated));
    return updated;
};

export const getAllCategories = () => {
    const custom = getCustomCategories();
    return [...CATEGORIES, ...custom];
};

// --- Clients Logic ---

export const getClients = (): string[] => {
    const stored = localStorage.getItem(STORAGE_KEY_CLIENTS);
    if (stored) {
        return JSON.parse(stored);
    }
    return INITIAL_CLIENTS;
};

export const saveClient = (newClientName: string) => {
    const current = getClients();
    if (!current.includes(newClientName)) {
        const updated = [...current, newClientName];
        localStorage.setItem(STORAGE_KEY_CLIENTS, JSON.stringify(updated));
        return updated;
    }
    return current;
};

// --- Backup Logic ---

export const exportBackupJSON = (transactions: Transaction[]) => {
    const data = {
        timestamp: new Date().toISOString(),
        transactions,
        clients: getClients(),
        customCategories: getCustomCategories(),
        initialBalance: getInitialBalance()
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const dateStr = new Date().toISOString().replace(/[:.]/g, '-').split('T');
    link.download = `LegalFlow_Backup_${dateStr[0]}_${dateStr[1].slice(0,5)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};"""

report_service_ts = r"""import { Transaction } from '../types';

export const generateExecutiveSummary = (
  period: 'month' | 'quarter' | 'year',
  transactions: Transaction[]
): string => {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  
  // Filter transactions based on period
  const relevantTransactions = transactions.filter(t => {
    const tDate = new Date(t.date);
    if (tDate.getFullYear() !== currentYear && period !== 'year') {
        // simple logic: if looking at monthly/quarterly, assume current year. 
        // For 'year' report, check specific year logic below if needed, but usually means "This Year".
        if (tDate.getFullYear() !== currentYear) return false; 
    }
    if (period === 'year' && tDate.getFullYear() !== currentYear) return false;

    if (period === 'month') {
      return tDate.getMonth() === currentMonth;
    } else if (period === 'quarter') {
      const currentQuarter = Math.floor(currentMonth / 3);
      const tQuarter = Math.floor(tDate.getMonth() / 3);
      return tQuarter === currentQuarter;
    }
    return true;
  });

  // Calculate basic stats
  const income = relevantTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
  const expenses = relevantTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
  const net = income - expenses;
  const profitMargin = income > 0 ? (net / income) * 100 : 0;

  // Group Analysis
  const expenseByGroup: Record<string, number> = {};
  relevantTransactions.filter(t => t.type === 'expense').forEach(t => {
      const g = t.group;
      expenseByGroup[g] = (expenseByGroup[g] || 0) + t.amount;
  });

  // Top Client Analysis (Income by Description)
  const clientIncome: Record<string, number> = {};
  relevantTransactions.filter(t => t.type === 'income').forEach(t => {
      // Assuming 'description' holds the client name or 'category' holds it? 
      // In TransactionForm, description is used for Client Name.
      const client = t.description || 'אחר'; 
      clientIncome[client] = (clientIncome[client] || 0) + t.amount;
  });
  const topClientEntry = Object.entries(clientIncome).sort((a, b) => b[1] - a[1])[0];

  // Pending Collection Analysis (Snapshot - All time)
  // Filter: Income + Pending + Category 'שכר טרחה'
  const pendingTransactions = transactions.filter(t => 
      t.type === 'income' && 
      t.status === 'pending' && 
      t.category === 'שכר טרחה'
  );
  const pendingAmount = pendingTransactions.reduce((s, t) => s + t.amount, 0);
  
  // Check for aging debts (> 30 days)
  const overdueCount = pendingTransactions.filter(t => {
      const days = Math.floor((now.getTime() - new Date(t.date).getTime()) / (1000 * 60 * 60 * 24));
      return days > 30;
  }).length;

  // Generate Text
  let periodText = '';
  switch(period) {
      case 'month': periodText = `חודש ${now.toLocaleString('he-IL', { month: 'long' })}`; break;
      case 'quarter': periodText = `רבעון ${Math.floor(currentMonth / 3) + 1}`; break;
      case 'year': periodText = `שנת ${currentYear}`; break;
  }

  return `
תקציר מנהלים - ${periodText}
עבור: משרד עו"ד ליאור פרי
תאריך הפקה: ${now.toLocaleDateString('he-IL')}
----------------------------------------

1. שורה תחתונה (פיננסית):
   סה"כ הכנסות: ₪${income.toLocaleString()}
   סה"כ הוצאות: ₪${expenses.toLocaleString()}
   -----------------------------------
   רווח נקי לתקופה: ₪${net.toLocaleString()} (${profitMargin.toFixed(1)}% רווחיות)

2. ניתוח הוצאות מרכזי:
   - תפעול שוטף: ₪${(expenseByGroup['operational'] || 0).toLocaleString()}
   - מיסים: ₪${(expenseByGroup['tax'] || 0).toLocaleString()}
   - החזרי הלוואות: ₪${(expenseByGroup['loan'] || 0).toLocaleString()}
   - משיכות אישיות: ₪${(expenseByGroup['personal'] || 0).toLocaleString()}

3. פעילות עסקית ולקוחות:
   ${topClientEntry ? `הלקוח המוביל בתקופה זו הוא "${topClientEntry[0]}" עם היקף של ₪${topClientEntry[1].toLocaleString()}.` : 'טרם נרשמו הכנסות בתקופה זו.'}

4. מצב גבייה (Snapshot עדכני):
   יתרת חוב לקוחות פתוחה (שכ"ט בלבד): ₪${pendingAmount.toLocaleString()}
   מספר דרישות תשלום פתוחות: ${pendingTransactions.length}
   ${overdueCount > 0 ? `⚠️ התראה: קיימים ${overdueCount} חשבונות בפיגור של מעל 30 יום!` : '✅ אין חריגות גבייה מעל 30 יום.'}

5. הערכת מצב ומסקנות:
${net > 0 ? 'המשרד נמצא במגמה חיובית.' : 'המשרד נמצא בגירעון לתקופה זו, יש לבחון את תזרים ההוצאות או מועדי הגבייה.'} 
${pendingAmount > 30000 ? 'המלצה: לבצע סבב טלפונים יזום לגביית חובות פתוחים.' : ''}

בברכה,
מערכת LegalFlow
`;
};"""

tax_service_ts = r"""import { Transaction } from '../types';

/**
 * This function takes the current list of transactions,
 * calculates the expected VAT and Income Tax for the NEXT month based on "Fee" income,
 * and upserts (updates or inserts) these tax transactions.
 */
export const syncTaxTransactions = (transactions: Transaction[]): Transaction[] => {
    // 1. Group Fee Income by Month (YYYY-MM)
    const monthlyFees: Record<string, number> = {};

    transactions.forEach(t => {
        if (t.type === 'income' && t.group === 'fee') {
            const date = new Date(t.date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            monthlyFees[key] = (monthlyFees[key] || 0) + t.amount;
        }
    });

    // 2. Create a map of existing auto-generated transactions to avoid duplication
    // Key: linkedMonth_taxType (e.g. "2024-01_vat")
    const existingAutoTaxes: Record<string, Transaction> = {};
    
    // We also need to keep track of manual transactions to not touch them,
    // but here we specifically look for ones we created (isAutoGenerated)
    const resultTransactions = [...transactions];

    resultTransactions.forEach(t => {
        if (t.isAutoGenerated && t.linkedMonth) {
            const key = `${t.linkedMonth}_${t.category}`; // category will be 'מע"מ' or 'מס הכנסה אישי'
            existingAutoTaxes[key] = t;
        }
    });

    // 3. Generate Taxes for Next Month
    Object.entries(monthlyFees).forEach(([monthKey, totalFee]) => {
        // Parse the monthKey (YYYY-MM)
        const [yearStr, monthStr] = monthKey.split('-');
        const incomeDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, 1);

        // Calculate Next Month
        const nextMonthDate = new Date(incomeDate);
        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
        
        const nextYear = nextMonthDate.getFullYear();
        const nextMonth = nextMonthDate.getMonth(); // 0-11

        // Calculate Amounts
        const vatAmount = totalFee * 0.18;
        const taxAmount = totalFee * 0.0833;

        // Define Dates
        // VAT: 25th
        const vatDate = new Date(nextYear, nextMonth, 25, 12, 0, 0).toISOString().split('T')[0];
        // Tax: 23rd
        const taxDate = new Date(nextYear, nextMonth, 23, 12, 0, 0).toISOString().split('T')[0];

        // --- Handle VAT Transaction ---
        const vatKey = `${monthKey}_מע"מ`;
        const existingVat = existingAutoTaxes[vatKey];

        if (existingVat) {
            // Update only if not manually overridden
            if (!existingVat.isManualOverride) {
                existingVat.amount = parseFloat(vatAmount.toFixed(2));
                // We generally don't update date if it already exists, allowing user to move it slightly without full override flag,
                // but for strict auto-sync, we might reset date. Let's just update amount.
            }
        } else {
            // Create new VAT transaction
            resultTransactions.push({
                id: `auto_vat_${monthKey}_${Date.now()}`,
                date: vatDate,
                amount: parseFloat(vatAmount.toFixed(2)),
                type: 'expense',
                group: 'tax',
                category: 'מע"מ',
                description: `מע"מ אוטומטי (בגין ${monthStr}/${yearStr})`,
                paymentMethod: 'transfer',
                status: 'pending', // Future payment
                isAutoGenerated: true,
                linkedMonth: monthKey,
                isManualOverride: false
            });
        }

        // --- Handle Income Tax Transaction ---
        const taxKey = `${monthKey}_מס הכנסה אישי`;
        const existingTax = existingAutoTaxes[taxKey];

        if (existingTax) {
            if (!existingTax.isManualOverride) {
                existingTax.amount = parseFloat(taxAmount.toFixed(2));
            }
        } else {
            // Create new Tax transaction
            resultTransactions.push({
                id: `auto_tax_${monthKey}_${Date.now()}`,
                date: taxDate,
                amount: parseFloat(taxAmount.toFixed(2)),
                type: 'expense',
                group: 'tax',
                category: 'מס הכנסה אישי',
                description: `מקדמות מס (בגין ${monthStr}/${yearStr})`,
                paymentMethod: 'transfer',
                status: 'pending',
                isAutoGenerated: true,
                linkedMonth: monthKey,
                isManualOverride: false
            });
        }
    });

    return resultTransactions;
};"""

dashboard_tsx = r"""import React, { useMemo } from 'react';
import { 
  AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, 
  BarChart, Bar, Cell, PieChart, Pie, Legend
} from 'recharts';
import { Transaction, Category } from '../types';
import { CATEGORIES } from '../constants';
import { TrendingUp, TrendingDown, Wallet, Scale, Activity, Info } from 'lucide-react';

interface DashboardProps {
  transactions: Transaction[];
  currentBalance: number;
}

const Dashboard: React.FC<DashboardProps> = ({ transactions, currentBalance }) => {

  // --- Calculations ---
  const summary = useMemo(() => {
    const income = transactions
      .filter(t => t.type === 'income')
      .reduce((sum, t) => sum + t.amount, 0);
    const expenses = transactions
      .filter(t => t.type === 'expense')
      .reduce((sum, t) => sum + t.amount, 0);
    return { income, expenses, net: income - expenses };
  }, [transactions]);

  const chartData = useMemo(() => {
    // Sort transactions by date
    const sorted = [...transactions].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
    
    // Accumulate balance over time (simplified for visual trend)
    let runningBalance = currentBalance - summary.net; // Start from beginning of period approx
    
    // Group by day for smoother chart
    const groupedByDay: Record<string, { date: string; balance: number; income: number; expense: number }> = {};
    
    sorted.forEach(t => {
      if (!groupedByDay[t.date]) {
        groupedByDay[t.date] = { date: t.date, balance: runningBalance, income: 0, expense: 0 };
      }
      if (t.type === 'income') {
        groupedByDay[t.date].income += t.amount;
        runningBalance += t.amount;
      } else {
        groupedByDay[t.date].expense += t.amount;
        runningBalance -= t.amount;
      }
      groupedByDay[t.date].balance = runningBalance;
    });

    return Object.values(groupedByDay);
  }, [transactions, currentBalance, summary]);

  const expensesByCategory = useMemo(() => {
    const data: Record<string, number> = {};
    transactions.filter(t => t.type === 'expense').forEach(t => {
      data[t.category] = (data[t.category] || 0) + t.amount;
    });
    
    return Object.keys(data).map(key => {
      const cat = CATEGORIES.find(c => c.name === key);
      return {
        name: key,
        value: data[key],
        color: cat ? cat.color : '#cbd5e1'
      };
    }).sort((a, b) => b.value - a.value);
  }, [transactions]);

  // --- Components ---

  const KPICard = ({ title, value, icon: Icon, trend, colorClass }: any) => (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
      <div className="flex justify-between items-start mb-4">
        <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10`}>
          <Icon className={`w-6 h-6 ${colorClass.replace('bg-', 'text-')}`} />
        </div>
        {trend && (
          <span className={`text-sm font-medium ${trend > 0 ? 'text-green-600' : 'text-red-600'} flex items-center`}>
            {trend > 0 ? '+' : ''}{trend}%
            {trend > 0 ? <TrendingUp className="w-4 h-4 mr-1" /> : <TrendingDown className="w-4 h-4 mr-1" />}
          </span>
        )}
      </div>
      <h3 className="text-slate-500 text-sm font-medium mb-1">{title}</h3>
      <p className="text-2xl font-bold text-slate-800">₪{value.toLocaleString()}</p>
    </div>
  );

  return (
    <div className="space-y-6">
      {/* KPI Row */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <KPICard 
          title="יתרה נוכחית" 
          value={currentBalance} 
          icon={Wallet} 
          colorClass="bg-blue-600" // Simplified color handling
        />
        <KPICard 
          title="הכנסות החודש" 
          value={summary.income} 
          icon={TrendingUp} 
          trend={12} 
          colorClass="bg-emerald-600"
        />
        <KPICard 
          title="הוצאות החודש" 
          value={summary.expenses} 
          icon={TrendingDown} 
          trend={-5} 
          colorClass="bg-red-600"
        />
        <KPICard 
          title="תזרים נטו" 
          value={summary.net} 
          icon={Scale} 
          colorClass="bg-purple-600"
        />
      </div>

      {/* Charts Row */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Main Trend Chart */}
        <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
              <Activity className="w-5 h-5 text-blue-600" />
              מגמת יתרה יומית
            </h3>
            <button className="text-sm text-blue-600 hover:underline">דוח מלא</button>
          </div>
          <div className="h-[300px] w-full">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={chartData}>
                <defs>
                  <linearGradient id="colorBalance" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#2563eb" stopOpacity={0.1}/>
                    <stop offset="95%" stopColor="#2563eb" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis 
                  dataKey="date" 
                  tickFormatter={(val) => new Date(val).getDate().toString()}
                  axisLine={false}
                  tickLine={false}
                  tick={{fill: '#94a3b8', fontSize: 12}}
                />
                <YAxis 
                  axisLine={false}
                  tickLine={false}
                  tick={{fill: '#94a3b8', fontSize: 12}}
                  tickFormatter={(value) => `₪${(value/1000).toFixed(0)}k`}
                />
                <RechartsTooltip 
                  formatter={(value: number) => `₪${value.toLocaleString()}`}
                  labelFormatter={(label) => new Date(label).toLocaleDateString('he-IL')}
                  contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                />
                <Area 
                  type="monotone" 
                  dataKey="balance" 
                  stroke="#2563eb" 
                  strokeWidth={3}
                  fillOpacity={1} 
                  fill="url(#colorBalance)" 
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Expenses Breakdown */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-6">התפלגות הוצאות</h3>
          <div className="h-[300px] w-full">
             {expensesByCategory.length > 0 ? (
               <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={expensesByCategory}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={80}
                    paddingAngle={5}
                    dataKey="value"
                  >
                    {expensesByCategory.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <RechartsTooltip formatter={(value: number) => `₪${value.toLocaleString()}`} />
                  <Legend layout="vertical" verticalAlign="bottom" align="center" iconType="circle" />
                </PieChart>
              </ResponsiveContainer>
             ) : (
               <div className="h-full flex flex-col items-center justify-center text-slate-400">
                 <Info className="w-8 h-8 mb-2" />
                 <p>אין נתונים להצגה</p>
               </div>
             )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;"""

transaction_form_tsx = r"""import React, { useState, useEffect } from 'react';
import { X, Repeat, AlertCircle } from 'lucide-react';
import { PAYMENT_METHODS } from '../constants';
import { getAllCategories, saveCustomCategory, getClients, saveClient } from '../services/storageService';
import { Transaction, TransactionGroup } from '../types';

interface TransactionFormProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (transactions: Omit<Transaction, 'id'>[]) => void;
  initialDate?: string;
  initialType?: 'income' | 'expense';
  initialGroup?: TransactionGroup;
}

const TransactionForm: React.FC<TransactionFormProps> = ({ 
  isOpen, 
  onClose, 
  onSubmit,
  initialDate,
  initialType,
  initialGroup
}) => {
  const [type, setType] = useState<'income' | 'expense'>('income');
  const [group, setGroup] = useState<TransactionGroup>('fee');
  
  const [amount, setAmount] = useState('');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [category, setCategory] = useState('');
  const [description, setDescription] = useState('');
  const [clientReference, setClientReference] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('transfer');
  const [status, setStatus] = useState<'pending' | 'completed'>('completed');
  
  const [availableCategories, setAvailableCategories] = useState(getAllCategories());
  const [availableClients, setAvailableClients] = useState<string[]>([]);

  const [isAddingCategory, setIsAddingCategory] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  
  const [isAddingClient, setIsAddingClient] = useState(false); 
  const [newClientName, setNewClientName] = useState('');

  const [isRecurring, setIsRecurring] = useState(false);
  const [recurringMonths, setRecurringMonths] = useState(12);

  // Flag to track manual override for tax calc. 
  // Generally user added transactions are "Manual" by definition relative to the auto-tax generator,
  // but this flag on the transaction object is mainly used for the Tax transactions themselves.
  // Here we just create standard transactions.

  useEffect(() => {
    if (isOpen) {
      setAvailableCategories(getAllCategories());
      setAvailableClients(getClients());

      if (initialDate) setDate(initialDate);
      
      if (initialGroup) {
          setGroup(initialGroup);
          setType((initialGroup === 'fee' || initialGroup === 'other_income') ? 'income' : 'expense');
      } else if (initialType) {
          setType(initialType);
          setGroup(initialType === 'income' ? 'fee' : 'operational');
      } else {
          setType('income');
          setGroup('fee');
      }
      
      setAmount('');
      setDescription('');
      setCategory('');
      setClientReference('');
      setPaymentMethod('transfer');
      
      // Defaults
      if (initialType === 'income' || (!initialType && !initialGroup)) {
          setStatus('pending');
      } else {
          setStatus('completed');
      }

      setIsRecurring(false);
      setRecurringMonths(12);
      
      setIsAddingCategory(false);
      setNewCategoryName('');
      setIsAddingClient(false);
      setNewClientName('');
    }
  }, [isOpen, initialDate, initialType, initialGroup]);

  const handleTypeChange = (newType: 'income' | 'expense') => {
      setType(newType);
      setCategory('');
      if (newType === 'income') {
          setGroup('fee'); // Default income
          setStatus('pending');
      } else {
          setGroup('operational'); // Default expense
          setStatus('completed');
      }
  };

  // Auto-set category name if Group is Fee (Implicit category)
  useEffect(() => {
      if (group === 'fee') {
          setCategory('שכר טרחה');
      }
  }, [group]);

  useEffect(() => {
    if (!category || category === 'ADD_NEW') return;

    const selectedCat = availableCategories.find(c => c.name === category);
    if (selectedCat) {
      if (selectedCat.defaultAmount !== undefined) {
        setAmount(selectedCat.defaultAmount.toString());
      }
      if (selectedCat.defaultDay !== undefined) {
        const currentDateObj = new Date(date);
        const year = currentDateObj.getFullYear();
        const month = currentDateObj.getMonth();
        const newDateObj = new Date(year, month, selectedCat.defaultDay, 12);
        setDate(newDateObj.toISOString().split('T')[0]);
      }
    }
  }, [category, availableCategories]);

  if (!isOpen) return null;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    let finalCategory = category;
    let finalDescription = description;

    if (category === 'ADD_NEW') {
        if (newCategoryName.trim()) {
            saveCustomCategory(newCategoryName, type, group); // Pass group to custom save
            finalCategory = newCategoryName;
        } else {
            alert('נא להזין שם לקטגוריה החדשה');
            return;
        }
    }

    // For Fee, we enforce category name
    if (group === 'fee') {
        finalCategory = 'שכר טרחה';
    }

    if (type === 'income' && description === 'ADD_NEW_CLIENT') {
        if (newClientName.trim()) {
            saveClient(newClientName);
            finalDescription = newClientName;
        } else {
            alert('נא להזין שם לקוח');
            return;
        }
    }

    // For manual tax/vat entries, we want to mark them as manual overrides so the auto-calc doesn't revert them
    // If user manually adds an expense in 'tax' group, we flag it.
    const isManualOverride = group === 'tax';

    const transactionsToCreate: Omit<Transaction, 'id'>[] = [];

    const baseTransaction = {
      amount: parseFloat(amount),
      type,
      group,
      category: finalCategory,
      description: finalDescription,
      clientReference,
      paymentMethod: paymentMethod as any,
      status,
      isRecurring: isRecurring,
      isManualOverride
    };

    if (isRecurring) {
        const startDate = new Date(date);
        for (let i = 0; i < recurringMonths; i++) {
            const nextDate = new Date(startDate);
            nextDate.setMonth(startDate.getMonth() + i);
            
            transactionsToCreate.push({
                ...baseTransaction,
                date: nextDate.toISOString().split('T')[0],
                status: i === 0 ? status : 'pending' 
            });
        }
    } else {
        transactionsToCreate.push({
            ...baseTransaction,
            date
        });
    }

    onSubmit(transactionsToCreate);
    onClose();
  };

  const filteredCategories = availableCategories.filter(c => c.group === group);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh] border border-slate-200">
        
        <div className="flex justify-between items-center p-5 border-b border-slate-100 bg-slate-50">
          <h2 className="text-xl font-bold text-slate-800">
            {initialGroup 
              ? 'הוספת תנועה'
              : 'הוספת תנועה חדשה'}
          </h2>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors">
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="p-6 overflow-y-auto">
          <form id="transaction-form" onSubmit={handleSubmit} className="space-y-4">
            
            {!initialGroup && (
              <div className="grid grid-cols-2 gap-4 p-1 bg-slate-100 rounded-lg mb-4">
                <button
                  type="button"
                  onClick={() => handleTypeChange('income')}
                  className={`py-2 text-sm font-medium rounded-md transition-all ${
                    type === 'income' 
                      ? 'bg-white text-emerald-600 shadow-sm' 
                      : 'text-slate-500 hover:text-slate-700'
                  }`}
                >
                  הכנסה
                </button>
                <button
                  type="button"
                  onClick={() => handleTypeChange('expense')}
                  className={`py-2 text-sm font-medium rounded-md transition-all ${
                    type === 'expense' 
                      ? 'bg-white text-red-600 shadow-sm' 
                      : 'text-slate-500 hover:text-slate-700'
                  }`}
                >
                  הוצאה
                </button>
              </div>
            )}

            {/* SUB GROUP SELECTION */}
            {!initialGroup && (
                <div className="flex p-1 bg-slate-50 rounded-lg mb-4 border border-slate-100 overflow-x-auto">
                    {type === 'income' ? (
                        <>
                         <button
                            type="button"
                            onClick={() => { setGroup('fee'); setCategory('שכר טרחה'); }}
                            className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all whitespace-nowrap ${
                                group === 'fee' 
                                    ? 'bg-emerald-600 text-white shadow-sm' 
                                    : 'text-slate-500 hover:text-emerald-800 hover:bg-emerald-50'
                            }`}
                        >
                            שכר טרחה
                        </button>
                        <button
                            type="button"
                            onClick={() => { setGroup('other_income'); setCategory(''); }}
                            className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all whitespace-nowrap ${
                                group === 'other_income' 
                                    ? 'bg-emerald-600 text-white shadow-sm' 
                                    : 'text-slate-500 hover:text-emerald-800 hover:bg-emerald-50'
                            }`}
                        >
                            הכנסות אחרות
                        </button>
                        </>
                    ) : (
                        <>
                        {[
                            { id: 'operational', label: 'תפעול שוטף' },
                            { id: 'tax', label: 'מיסים' },
                            { id: 'loan', label: 'הלוואות' },
                            { id: 'personal', label: 'אישי' }
                        ].map(g => (
                            <button
                                key={g.id}
                                type="button"
                                onClick={() => { setGroup(g.id as TransactionGroup); setCategory(''); }}
                                className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all whitespace-nowrap ${
                                    group === g.id 
                                        ? 'bg-slate-800 text-white shadow-sm' 
                                        : 'text-slate-500 hover:text-slate-800 hover:bg-slate-200'
                                }`}
                            >
                                {g.label}
                            </button>
                        ))}
                        </>
                    )}
                </div>
            )}

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">סכום (₪)</label>
                <input
                  type="number"
                  required
                  min="0"
                  step="0.01"
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                  className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-semibold"
                  autoFocus
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    {type === 'income' ? 'תאריך הנפקה/דרישה' : 'תאריך תשלום'}
                </label>
                <input
                  type="date"
                  required
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                  className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            {/* Category Selection */}
            {/* Hide category selection for Fee, show simple text */}
            {group === 'fee' ? (
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">קטגוריה</label>
                    <div className="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-100 text-slate-500 cursor-not-allowed">
                        שכר טרחה
                    </div>
                </div>
            ) : (
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">קטגוריה</label>
                    {isAddingCategory ? (
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={newCategoryName}
                                onChange={(e) => setNewCategoryName(e.target.value)}
                                placeholder="הקלד שם קטגוריה חדשה..."
                                className="flex-1 px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50"
                                autoFocus
                            />
                            <button 
                                type="button" 
                                onClick={() => { setIsAddingCategory(false); setCategory(''); }}
                                className="px-3 py-2 text-slate-500 hover:bg-slate-100 rounded-lg"
                            >
                                ביטול
                            </button>
                        </div>
                    ) : (
                        <select
                            required
                            value={category}
                            onChange={(e) => {
                                if (e.target.value === 'ADD_NEW') {
                                    setIsAddingCategory(true);
                                    setCategory('ADD_NEW');
                                } else {
                                    setCategory(e.target.value);
                                }
                            }}
                            className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                        >
                            <option value="" disabled>בחר קטגוריה</option>
                            {filteredCategories.map(cat => (
                            <option key={cat.id} value={cat.name}>
                                {cat.name}
                            </option>
                            ))}
                            <option value="ADD_NEW" className="font-bold text-blue-600 bg-slate-50">➕ הוסף קטגוריה חדשה...</option>
                        </select>
                    )}
                </div>
            )}

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                {type === 'income' ? 'שם הלקוח' : 'תיאור'}
              </label>
              
              {type === 'income' ? (
                isAddingClient ? (
                    <div className="flex gap-2">
                        <input 
                            type="text" 
                            value={newClientName}
                            onChange={(e) => setNewClientName(e.target.value)}
                            placeholder="הקלד שם לקוח חדש..."
                            className="flex-1 px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50"
                            autoFocus
                        />
                        <button 
                            type="button" 
                            onClick={() => { setIsAddingClient(false); setDescription(''); }}
                            className="px-3 py-2 text-slate-500 hover:bg-slate-100 rounded-lg"
                        >
                            ביטול
                        </button>
                    </div>
                ) : (
                    <select
                        required
                        value={description}
                        onChange={(e) => {
                            if (e.target.value === 'ADD_NEW_CLIENT') {
                                setIsAddingClient(true);
                                setDescription('ADD_NEW_CLIENT');
                            } else {
                                setDescription(e.target.value);
                            }
                        }}
                        className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                    >
                        <option value="" disabled>בחר לקוח</option>
                        {availableClients.map((client, idx) => (
                            <option key={idx} value={client}>{client}</option>
                        ))}
                        <option value="ADD_NEW_CLIENT" className="font-bold text-blue-600 bg-slate-50">➕ הוסף לקוח חדש...</option>
                    </select>
                )
              ) : (
                <input
                    type="text"
                    required
                    placeholder="תיאור ההוצאה"
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              )}
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">מספר תיק/אסמכתא</label>
                <input
                  type="text"
                  value={clientReference}
                  onChange={(e) => setClientReference(e.target.value)}
                  className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">אמצעי תשלום</label>
                <select
                  value={paymentMethod}
                  onChange={(e) => setPaymentMethod(e.target.value)}
                  className="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                >
                  {PAYMENT_METHODS.map(m => (
                    <option key={m.value} value={m.value}>{m.label}</option>
                  ))}
                </select>
              </div>
            </div>
            
            <div className="flex flex-col gap-2 pt-2">
                <div className={`flex items-center gap-3 p-3 rounded-lg border transition-colors cursor-pointer ${status === 'completed' ? 'bg-emerald-50 border-emerald-100' : 'bg-amber-50 border-amber-100'}`} onClick={() => setStatus(prev => prev === 'completed' ? 'pending' : 'completed')}>
                    <div className={`w-5 h-5 rounded-full flex items-center justify-center border ${status === 'completed' ? 'border-emerald-600 bg-emerald-600' : 'border-amber-500 bg-white'}`}>
                        {status === 'completed' && <div className="w-2 h-2 bg-white rounded-full" />}
                    </div>
                    <div className="flex-1">
                        <span className={`block text-sm font-bold ${status === 'completed' ? 'text-emerald-800' : 'text-amber-800'}`}>
                            {type === 'income' 
                                ? (status === 'completed' ? 'התשלום התקבל בחשבון' : 'דרישה נשלחה (ממתין לתשלום)')
                                : (status === 'completed' ? 'שולם' : 'תשלום עתידי')}
                        </span>
                        <span className="text-xs text-slate-500">
                            {type === 'income' && status === 'pending' && 'יופיע בדוח "מעקב גבייה" עד לתשלום'}
                        </span>
                    </div>
                </div>

                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 transition-all">
                    <div className="flex items-center gap-3 mb-2">
                         <input 
                            type="checkbox" 
                            id="recurring" 
                            checked={isRecurring}
                            onChange={(e) => setIsRecurring(e.target.checked)}
                            className="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500"
                        />
                        <label htmlFor="recurring" className="text-sm font-bold text-blue-800 select-none cursor-pointer flex items-center gap-2">
                            <Repeat className="w-4 h-4" />
                            הגדר כהוראת קבע / תנועה חוזרת
                        </label>
                    </div>
                    
                    {isRecurring && (
                         <div className="flex items-center gap-2 mr-7 animation-fade-in">
                             <span className="text-sm text-blue-700">חזור למשך</span>
                             <input 
                                type="number" 
                                min="2" 
                                max="60" 
                                value={recurringMonths}
                                onChange={(e) => setRecurringMonths(parseInt(e.target.value))}
                                className="w-16 px-2 py-1 text-sm border border-blue-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-center"
                             />
                             <span className="text-sm text-blue-700">חודשים</span>
                         </div>
                    )}
                </div>
            </div>

          </form>
        </div>

        <div className="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
          <button 
            onClick={onClose}
            className="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-200 rounded-lg transition-colors"
          >
            ביטול
          </button>
          <button 
            form="transaction-form"
            type="submit"
            className="px-6 py-2 text-sm font-medium text-white bg-slate-900 hover:bg-slate-800 rounded-lg transition-colors shadow-sm flex items-center gap-2"
          >
            {isRecurring ? `צור ${recurringMonths} תנועות` : 'שמור תנועה'}
          </button>
        </div>
      </div>
    </div>
  );
};

export default TransactionForm;"""

transaction_list_tsx = r"""import React from 'react';
import { Transaction } from '../types';
import { ArrowUpRight, ArrowDownLeft, Search, FileText, Hash } from 'lucide-react';

interface TransactionListProps {
  transactions: Transaction[];
  onDelete: (id: string) => void;
}

const TransactionList: React.FC<TransactionListProps> = ({ transactions, onDelete }) => {
  // Simple date formatter
  const formatDate = (dateStr: string) => {
    const d = new Date(dateStr);
    return d.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric', year: '2-digit' });
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
      <div className="p-5 border-b border-slate-100 flex justify-between items-center">
        <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
          <FileText className="w-5 h-5 text-blue-600" />
          פירוט תנועות
        </h3>
        <div className="relative">
          <Search className="w-4 h-4 absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" />
          <input 
            type="text" 
            placeholder="חיפוש בתיאור או תיק..." 
            className="pr-9 pl-4 py-1.5 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64"
          />
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="w-full text-sm text-right">
          <thead className="bg-slate-50 text-slate-500 font-medium">
            <tr>
              <th className="px-6 py-3 border-b border-slate-100">תאריך</th>
              <th className="px-6 py-3 border-b border-slate-100">סוג</th>
              <th className="px-6 py-3 border-b border-slate-100">תיאור</th>
              <th className="px-6 py-3 border-b border-slate-100">קטגוריה</th>
              <th className="px-6 py-3 border-b border-slate-100">אסמכתא/תיק</th>
              <th className="px-6 py-3 border-b border-slate-100">סכום</th>
              <th className="px-6 py-3 border-b border-slate-100"></th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-50">
            {transactions.length === 0 ? (
              <tr>
                <td colSpan={7} className="px-6 py-10 text-center text-slate-400">
                  לא נמצאו תנועות
                </td>
              </tr>
            ) : (
              transactions.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).map((t) => (
                <tr key={t.id} className="hover:bg-slate-50 transition-colors group">
                  <td className="px-6 py-4 text-slate-600">{formatDate(t.date)}</td>
                  <td className="px-6 py-4">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      t.type === 'income' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'
                    }`}>
                      {t.type === 'income' ? <ArrowDownLeft className="w-3 h-3 ml-1" /> : <ArrowUpRight className="w-3 h-3 ml-1" />}
                      {t.type === 'income' ? 'הכנסה' : 'הוצאה'}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-slate-800 font-medium">{t.description}</td>
                  <td className="px-6 py-4 text-slate-500">{t.category}</td>
                  <td className="px-6 py-4 text-slate-500">
                    {t.clientReference && (
                      <span className="inline-flex items-center gap-1 bg-slate-100 px-2 py-1 rounded text-xs">
                        <Hash className="w-3 h-3" />
                        {t.clientReference}
                      </span>
                    )}
                  </td>
                  <td className={`px-6 py-4 font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}`}>
                    {t.type === 'income' ? '+' : '-'}₪{t.amount.toLocaleString()}
                  </td>
                  <td className="px-6 py-4 text-left">
                     <button 
                        onClick={() => onDelete(t.id)}
                        className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"
                     >
                       מחק
                     </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default TransactionList;"""

app_tsx = r"""import React, { useState, useEffect } from 'react';
import { Plus, LayoutDashboard, Table2, LogOut, Briefcase, FileText, ShieldCheck } from 'lucide-react';
import { Transaction, TransactionGroup } from './types';
import { getTransactions, saveTransactions, getInitialBalance, exportBackupJSON } from './services/storageService';
import { generateExecutiveSummary } from './services/reportService';
import { syncTaxTransactions } from './services/taxService';
import Dashboard from './components/Dashboard';
import TransactionForm from './components/TransactionForm';
import MonthlyFlow from './components/MonthlyFlow';
import CollectionTracker from './components/CollectionTracker';
import ExecutiveSummary from './components/ExecutiveSummary';
import Logo from './components/Logo';
import Login from './components/Login';

const App: React.FC = () => {
  // Auth State
  const [currentUser, setCurrentUser] = useState<string | null>(() => sessionStorage.getItem('legalflow_user'));
  
  // App State - Lazy initialization ensures we read from storage on first render before any overwrites
  const [transactions, setTransactions] = useState<Transaction[]>(() => {
      const stored = getTransactions();
      // Run sync once on load to ensure old data generates taxes if missing
      return syncTaxTransactions(stored);
  });
  
  const [initialBalance, setInitialBalance] = useState(() => getInitialBalance());
  const [isFormOpen, setIsFormOpen] = useState(false);
  
  // Updated tabs
  const [activeTab, setActiveTab] = useState<'dashboard' | 'flow' | 'collection' | 'summary'>('flow');

  // Form initial state helpers
  const [formInitialDate, setFormInitialDate] = useState<string | undefined>(undefined);
  const [formInitialType, setFormInitialType] = useState<'income' | 'expense' | undefined>(undefined);
  const [formInitialGroup, setFormInitialGroup] = useState<TransactionGroup | undefined>(undefined);

  // --- Persistence ---
  useEffect(() => {
     // Whenever transactions change, we save them.
     // Note: The sync logic is handled inside the update handlers to avoid infinite loops in useEffect
     saveTransactions(transactions);
  }, [transactions]);

  // --- 3-Hour Automatic Backup ---
  useEffect(() => {
    if (!currentUser) return;

    // 3 Hours in milliseconds
    const INTERVAL_MS = 3 * 60 * 60 * 1000;
    
    const backupTimer = setInterval(() => {
        console.log('Executing scheduled backup...');
        exportBackupJSON(transactions); 
    }, INTERVAL_MS);

    return () => clearInterval(backupTimer);
  }, [currentUser, transactions]);

  // --- 16:00 Daily Email Trigger ---
  useEffect(() => {
      if (!currentUser) return;

      const emailCheckTimer = setInterval(() => {
          const now = new Date();
          if (now.getHours() === 16 && now.getMinutes() === 0 && now.getSeconds() < 10) {
              const subject = `סיכום תזרים יומי - ${now.toLocaleDateString('he-IL')}`;
              const body = encodeURIComponent(generateExecutiveSummary('month', transactions));
              window.location.href = `mailto:lidor@lp-law.co.il,lior@lp-law.co.il?subject=${subject}&body=${body}`;
          }
      }, 10000);

      return () => clearInterval(emailCheckTimer);
  }, [currentUser, transactions]);


  // --- Handlers ---

  const handleLogin = (username: string) => {
    setCurrentUser(username);
    sessionStorage.setItem('legalflow_user', username);
  };

  const handleLogout = () => {
    setCurrentUser(null);
    sessionStorage.removeItem('legalflow_user');
  };

  // Helper to update transactions and sync taxes
  const updateTransactionsWithSync = (newTransactionsList: Transaction[]) => {
      const synced = syncTaxTransactions(newTransactionsList);
      setTransactions(synced);
  };

  const handleAddTransactionBatch = (newTransactions: Omit<Transaction, 'id'>[]) => {
      const processedTransactions = newTransactions.map(t => ({
          ...t,
          id: crypto.randomUUID()
      }));
      
      const updatedList = [...transactions, ...processedTransactions];
      updateTransactionsWithSync(updatedList);
  };

  const handleAddTransaction = (newTransaction: Omit<Transaction, 'id'>) => {
    handleAddTransactionBatch([newTransaction]);
  };

  const handleDeleteTransaction = (id: string) => {
    if(window.confirm('האם אתה בטוח שברצונך למחוק תנועה זו?')) {
        const updatedList = transactions.filter(t => t.id !== id);
        updateTransactionsWithSync(updatedList);
    }
  };

  const handleMarkAsPaid = (transaction: Transaction) => {
      if(window.confirm(`האם לסמן את החשבון של ${transaction.description} כשולם?`)) {
          const updated = transactions.map(t => 
            t.id === transaction.id ? { ...t, status: 'completed' as const } : t
          );
          // No need to sync taxes here as amount/date didn't change, but status change is fine.
          setTransactions(updated); 
      }
  };

  const openTransactionForm = (date?: string, type?: 'income' | 'expense', group?: TransactionGroup) => {
    setFormInitialDate(date || new Date().toISOString().split('T')[0]);
    setFormInitialType(type);
    setFormInitialGroup(group);
    setIsFormOpen(true);
  };

  const handleCloseForm = () => {
    setIsFormOpen(false);
    setTimeout(() => {
      setFormInitialDate(undefined);
      setFormInitialType(undefined);
      setFormInitialGroup(undefined);
    }, 200);
  };

  const calculateCurrentBalance = () => {
    const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    return initialBalance + income - expenses;
  };

  if (!currentUser) {
    return <Login onLogin={handleLogin} />;
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      
      {/* Sidebar */}
      <aside className="fixed top-0 right-0 h-full w-64 bg-slate-900 text-white shadow-xl z-20 hidden md:flex flex-col">
        <div className="p-6 border-b border-slate-800 flex flex-col items-center justify-center py-8">
          <Logo />
          <div className="mt-4 text-xs text-slate-500 uppercase tracking-wider font-medium flex items-center gap-1">
            <ShieldCheck className="w-3 h-3 text-green-500" />
            מחובר: {currentUser}
          </div>
        </div>
        
        <nav className="flex-1 p-4 space-y-2 mt-2 overflow-y-auto">
          <div className="text-xs text-slate-500 font-bold px-4 mb-2 mt-2">תזרים ובקרה</div>
          <button 
            onClick={() => setActiveTab('flow')}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
              activeTab === 'flow' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
            }`}
          >
            <Table2 className="w-5 h-5" />
            תזרים חודשי
          </button>
          <button 
            onClick={() => setActiveTab('dashboard')}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
              activeTab === 'dashboard' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
            }`}
          >
            <LayoutDashboard className="w-5 h-5" />
            לוח בקרה
          </button>

          <div className="text-xs text-slate-500 font-bold px-4 mb-2 mt-6">ניהול משרד</div>
          <button 
            onClick={() => setActiveTab('summary')}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
              activeTab === 'summary' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
            }`}
          >
            <FileText className="w-5 h-5" />
            תקציר מנהלים
          </button>

           <button 
            onClick={() => setActiveTab('collection')}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
              activeTab === 'collection' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
            }`}
          >
            <Briefcase className="w-5 h-5" />
            מעקב גבייה
          </button>
        </nav>

        <div className="p-4 border-t border-slate-800 space-y-4">
          <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
            <p className="text-xs text-slate-400 mb-1">יתרה נוכחית</p>
            <p className="text-xl font-bold text-[#d4af37]">{calculateCurrentBalance().toLocaleString()} ₪</p>
          </div>
          
          <button 
            onClick={handleLogout}
            className="w-full flex items-center gap-2 px-4 py-2 text-slate-400 hover:text-red-400 hover:bg-slate-800/50 rounded-lg transition-colors text-sm"
          >
            <LogOut className="w-4 h-4" />
            התנתק
          </button>
        </div>
      </aside>

      {/* Mobile Header */}
      <div className="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-30">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 relative">
             <svg viewBox="0 0 100 100" className="w-full h-full">
                <path d="M25 20 V80 H75" fill="none" stroke="#d4af37" strokeWidth="10" strokeLinecap="square"/>
                <path d="M25 20 H65 C75 20 80 30 80 40 C80 55 70 60 60 60 H25" fill="none" stroke="#94a3b8" strokeWidth="10" strokeLinecap="square" className="opacity-80"/>
             </svg>
          </div>
          <span className="font-bold text-[#d4af37] tracking-wide">LegalFlow</span>
        </div>
        <div className="flex items-center gap-4">
            <div className="text-sm font-bold text-white">₪{calculateCurrentBalance().toLocaleString()}</div>
            <button onClick={handleLogout} className="text-slate-400 hover:text-white">
                <LogOut className="w-5 h-5" />
            </button>
        </div>
      </div>

      {/* Main Content */}
      <main className="md:mr-64 p-6 min-h-screen pb-24 md:pb-6">
        {/* Top Action Bar */}
        {activeTab !== 'flow' && (
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div>
              <h2 className="text-2xl font-bold text-slate-800">
                {activeTab === 'dashboard' && 'סקירה חודשית'}
                {activeTab === 'collection' && 'מעקב גבייה'}
                {activeTab === 'summary' && 'תקציר מנהלים'}
              </h2>
              <p className="text-slate-500 text-sm mt-1">
                {new Date().toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </p>
            </div>
            
            <div className="flex gap-3">
              <button 
                onClick={() => openTransactionForm()}
                className="flex items-center gap-2 px-4 py-2 bg-[#d4af37] text-white rounded-lg hover:bg-[#b5952f] transition-all shadow-lg hover:shadow-xl text-sm font-medium"
              >
                <Plus className="w-4 h-4" />
                תנועה חדשה
              </button>
            </div>
          </div>
        )}

        {/* Views */}
        {activeTab === 'flow' && (
          <MonthlyFlow 
            transactions={transactions}
            initialBalance={initialBalance}
            onAddTransaction={handleAddTransaction} 
            onAddBatch={handleAddTransactionBatch}
            onDeleteTransaction={handleDeleteTransaction}
            openTransactionForm={openTransactionForm}
          />
        )}

        {activeTab === 'dashboard' && (
          <Dashboard 
            transactions={transactions} 
            currentBalance={calculateCurrentBalance()} 
          />
        )}

        {activeTab === 'collection' && (
            <CollectionTracker 
                transactions={transactions}
                onMarkAsPaid={handleMarkAsPaid}
            />
        )}

        {activeTab === 'summary' && (
            <ExecutiveSummary transactions={transactions} />
        )}
      </main>

      {/* Mobile Bottom Nav */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-3 z-30 safe-area-pb">
        <button onClick={() => setActiveTab('flow')} className={`flex flex-col items-center gap-1 ${activeTab === 'flow' ? 'text-[#d4af37]' : 'text-slate-400'}`}>
          <Table2 className="w-6 h-6" />
          <span className="text-[10px]">תזרים</span>
        </button>
        <button onClick={() => setActiveTab('collection')} className={`flex flex-col items-center gap-1 ${activeTab === 'collection' ? 'text-[#d4af37]' : 'text-slate-400'}`}>
          <Briefcase className="w-6 h-6" />
          <span className="text-[10px]">גבייה</span>
        </button>
        <button onClick={() => openTransactionForm()} className="flex flex-col items-center justify-center -mt-8">
          <div className="bg-slate-900 p-3 rounded-full shadow-lg text-[#d4af37] border-2 border-[#d4af37]">
            <Plus className="w-6 h-6" />
          </div>
        </button>
        <button onClick={() => setActiveTab('summary')} className={`flex flex-col items-center gap-1 ${activeTab === 'summary' ? 'text-[#d4af37]' : 'text-slate-400'}`}>
          <FileText className="w-6 h-6" />
          <span className="text-[10px]">מנהלים</span>
        </button>
      </div>

      <TransactionForm 
        isOpen={isFormOpen} 
        onClose={handleCloseForm} 
        onSubmit={handleAddTransactionBatch} 
        initialDate={formInitialDate}
        initialType={formInitialType}
        initialGroup={formInitialGroup}
      />

    </div>
  );
};

export default App;"""

monthly_flow_tsx = r"""import React, { useState, useMemo } from 'react';
import { ChevronRight, ChevronLeft, Plus, Info, Receipt, Car, Home, Download } from 'lucide-react';
import { Transaction, TransactionGroup } from '../types';
import DailyDetailModal from './DailyDetailModal';

interface MonthlyFlowProps {
  transactions: Transaction[];
  initialBalance: number;
  onAddTransaction: (t: Omit<Transaction, 'id'>) => void; 
  onAddBatch: (ts: Omit<Transaction, 'id'>[]) => void;
  onDeleteTransaction: (id: string) => void;
  openTransactionForm: (date?: string, type?: 'income' | 'expense', group?: TransactionGroup) => void;
}

const MonthlyFlow: React.FC<MonthlyFlowProps> = ({ 
  transactions, 
  initialBalance, 
  onAddBatch,
  onDeleteTransaction,
  openTransactionForm 
}) => {
  const [currentDate, setCurrentDate] = useState(new Date());
  
  const [detailModalOpen, setDetailModalOpen] = useState(false);
  const [selectedCell, setSelectedCell] = useState<{
    date: string;
    group: TransactionGroup;
    transactions: Transaction[];
  } | null>(null);

  // --- Date Logic ---
  const daysInMonth = useMemo(() => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const date = new Date(year, month, 1);
    const days = [];
    while (date.getMonth() === month) {
      days.push(new Date(date));
      date.setDate(date.getDate() + 1);
    }
    return days;
  }, [currentDate]);

  // --- Financial Logic ---
  const monthStartBalance = useMemo(() => {
    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const previousTransactions = transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate < startOfMonth; 
    });

    const prevIncome = previousTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
        
    const prevExpense = previousTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
        
    return initialBalance + prevIncome - prevExpense;
  }, [transactions, currentDate, initialBalance]);

  const dailyData = useMemo(() => {
    let runningBalance = monthStartBalance;
    
    return daysInMonth.map(day => {
      const dateStr = day.toISOString().split('T')[0];
      const dayTransactions = transactions.filter(t => t.date === dateStr);
      
      // Split Income groups
      const feeIncome = dayTransactions.filter(t => t.group === 'fee');
      const otherIncome = dayTransactions.filter(t => t.group === 'other_income');
      
      const operational = dayTransactions.filter(t => t.group === 'operational');
      const tax = dayTransactions.filter(t => t.group === 'tax');
      const loan = dayTransactions.filter(t => t.group === 'loan');
      const personal = dayTransactions.filter(t => t.group === 'personal');
      
      const feeSum = feeIncome.reduce((sum, t) => sum + t.amount, 0);
      const otherIncomeSum = otherIncome.reduce((sum, t) => sum + t.amount, 0);
      
      const operationalSum = operational.reduce((sum, t) => sum + t.amount, 0);
      const taxSum = tax.reduce((sum, t) => sum + t.amount, 0);
      const loanSum = loan.reduce((sum, t) => sum + t.amount, 0);
      const personalSum = personal.reduce((sum, t) => sum + t.amount, 0);
      
      // Daily change
      const dailyChange = (feeSum + otherIncomeSum) - (operationalSum + taxSum + loanSum + personalSum);
      runningBalance += dailyChange;

      return {
        date: day,
        dateStr,
        fee: { sum: feeSum, transactions: feeIncome },
        otherIncome: { sum: otherIncomeSum, transactions: otherIncome },
        operational: { sum: operationalSum, transactions: operational },
        tax: { sum: taxSum, transactions: tax },
        loan: { sum: loanSum, transactions: loan },
        personal: { sum: personalSum, transactions: personal },
        balance: runningBalance
      };
    });
  }, [daysInMonth, transactions, monthStartBalance]);

  const monthSummary = useMemo(() => {
    return dailyData.reduce((acc, day) => ({
        fee: acc.fee + day.fee.sum,
        otherIncome: acc.otherIncome + day.otherIncome.sum,
        tax: acc.tax + day.tax.sum,
        operational: acc.operational + day.operational.sum,
        loan: acc.loan + day.loan.sum,
        personal: acc.personal + day.personal.sum
    }), { fee: 0, otherIncome: 0, tax: 0, operational: 0, loan: 0, personal: 0 });
  }, [dailyData]);

  // --- Actions ---
  const handleCellClick = (dateStr: string, group: TransactionGroup, cellTransactions: Transaction[]) => {
    if (cellTransactions.length > 0) {
      setSelectedCell({ date: dateStr, group, transactions: cellTransactions });
      setDetailModalOpen(true);
    } else {
      const type = (group === 'fee' || group === 'other_income') ? 'income' : 'expense';
      openTransactionForm(dateStr, type, group);
    }
  };

  const handleExportToCSV = () => {
    const headers = ['תאריך', 'שכר טרחה', 'הכנסות אחרות', 'הוצאות תפעול', 'מיסים', 'הלוואות', 'משיכות', 'יתרה'];
    const rows = dailyData.map(day => [
      day.date.toLocaleDateString('he-IL'),
      day.fee.sum || '',
      day.otherIncome.sum || '',
      day.operational.sum || '',
      day.tax.sum || '',
      day.loan.sum || '',
      day.personal.sum || '',
      day.balance
    ]);

    const csvContent = '\uFEFF' + [
      headers.join(','), 
      ...rows.map(e => e.join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `תזרים_${currentDate.getMonth()+1}_${currentDate.getFullYear()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const formatCurrency = (val: number) => `₪${val.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
  const formatDate = (date: Date) => date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const navigateMonth = (dir: number) => {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() + dir);
    setCurrentDate(newDate);
  };

  // --- Render ---
  return (
    <>
    <div className="space-y-6 h-full flex flex-col">
      
      {/* Top Control Bar */}
      <div className="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200 gap-4">
        <div className="flex items-center gap-4">
            <button onClick={() => navigateMonth(-1)} className="p-2 hover:bg-slate-100 rounded-full transition-colors">
                <ChevronRight className="w-5 h-5 text-slate-600" />
            </button>
            <div className="text-center">
                <h2 className="text-xl font-bold text-slate-800">
                    {currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}
                </h2>
                <p className="text-xs text-slate-500 font-medium">יתרת פתיחה: {formatCurrency(monthStartBalance)}</p>
            </div>
            <button onClick={() => navigateMonth(1)} className="p-2 hover:bg-slate-100 rounded-full transition-colors">
                <ChevronLeft className="w-5 h-5 text-slate-600" />
            </button>
        </div>

        <div className="flex flex-wrap gap-3 justify-center text-sm items-center">
            <div className="px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg border border-emerald-100 text-center">
                <span className="block text-xs text-emerald-500 mb-1">סה"כ שכר טרחה</span>
                <span className="font-bold text-lg">{formatCurrency(monthSummary.fee)}</span>
            </div>
            <div className="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg border border-blue-100 text-center">
                <span className="block text-xs text-blue-500 mb-1">תזרים נטו</span>
                <span className="font-bold text-lg">{formatCurrency((monthSummary.fee + monthSummary.otherIncome) - (monthSummary.operational + monthSummary.tax + monthSummary.loan + monthSummary.personal))}</span>
            </div>
            <button 
              onClick={handleExportToCSV}
              className="flex items-center gap-2 px-4 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors shadow-sm"
            >
              <Download className="w-4 h-4" />
              <span className="hidden sm:inline">אקסל</span>
            </button>
        </div>
      </div>

      {/* Main Grid */}
      <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col min-h-[600px]">
            <div className="overflow-auto flex-1">
                <table className="w-full text-sm text-center border-collapse relative min-w-[900px]">
                    <thead className="bg-slate-900 text-white text-xs sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th className="px-2 py-3 font-medium w-[90px]">תאריך</th>
                            {/* Fee Column */}
                            <th className="px-2 py-3 font-bold bg-emerald-900 border-r border-slate-700">שכר טרחה</th>
                            {/* Other Income */}
                            <th className="px-2 py-3 font-medium bg-emerald-800/60 border-r border-slate-700">הכנסות אחרות</th>
                            <th className="px-2 py-3 font-medium border-r border-slate-700">הוצאה</th>
                            <th className="px-2 py-3 font-medium border-r border-slate-700">מיסים</th>
                            <th className="px-2 py-3 font-medium border-r border-slate-700">הלוואות</th>
                            <th className="px-2 py-3 font-medium border-r border-slate-700">משיכות</th>
                            <th className="px-2 py-3 font-medium bg-slate-800 border-r border-slate-700">יתרה</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 text-xs">
                        {dailyData.map((day) => {
                             const isWeekend = day.date.getDay() === 5 || day.date.getDay() === 6; 
                             const isToday = day.dateStr === new Date().toISOString().split('T')[0];
                             const rowClass = isToday 
                                ? 'bg-blue-100 relative z-10 ring-2 ring-blue-600 ring-inset shadow-md' 
                                : `hover:bg-slate-50 transition-colors ${isWeekend ? 'bg-slate-50/50' : ''}`;

                             return (
                            <tr key={day.dateStr} className={rowClass}>
                                <td className={`px-2 py-2 border-l border-slate-100 font-medium sticky right-0 z-0 ${isToday ? 'bg-blue-100 text-blue-800 font-bold' : 'text-slate-500 bg-inherit'}`}>
                                    {formatDate(day.date)}
                                    {isToday && <span className="block text-[10px] text-blue-600 font-normal">היום</span>}
                                </td>
                                
                                {/* FEE CELL */}
                                <td 
                                    onClick={() => handleCellClick(day.dateStr, 'fee', day.fee.transactions)}
                                    className="px-1 py-1 cursor-pointer group border-r border-slate-100 relative hover:bg-slate-100 bg-emerald-50/30"
                                >
                                    {day.fee.sum > 0 ? (
                                        <span className="font-bold text-emerald-700 bg-emerald-100 px-1.5 py-0.5 rounded block">
                                            {formatCurrency(day.fee.sum)}
                                        </span>
                                    ) : (
                                        <span className="opacity-0 group-hover:opacity-100 flex justify-center">
                                            <Plus className="w-4 h-4 text-emerald-400" />
                                        </span>
                                    )}
                                </td>

                                {/* OTHER INCOME CELL */}
                                <td 
                                    onClick={() => handleCellClick(day.dateStr, 'other_income', day.otherIncome.transactions)}
                                    className="px-1 py-1 cursor-pointer group border-r border-slate-100 hover:bg-slate-100"
                                >
                                    {day.otherIncome.sum > 0 ? (
                                        <span className="font-medium text-emerald-600 block">
                                            {formatCurrency(day.otherIncome.sum)}
                                        </span>
                                    ) : (
                                        <span className="opacity-0 group-hover:opacity-100 flex justify-center">
                                            <Plus className="w-4 h-4 text-emerald-300" />
                                        </span>
                                    )}
                                </td>

                                {/* OPERATIONAL */}
                                <td 
                                    onClick={() => handleCellClick(day.dateStr, 'operational', day.operational.transactions)}
                                    className="px-1 py-1 cursor-pointer group border-r border-slate-100 hover:bg-slate-100"
                                >
                                    {day.operational.sum > 0 ? (
                                        <span className="font-medium text-red-600 block">
                                            {formatCurrency(day.operational.sum)}
                                        </span>
                                    ) : (
                                        <span className="opacity-0 group-hover:opacity-100 flex justify-center">
                                            <Plus className="w-4 h-4 text-red-300" />
                                        </span>
                                    )}
                                </td>

                                {/* TAX */}
                                <td 
                                    onClick={() => handleCellClick(day.dateStr, 'tax', day.tax.transactions)}
                                    className="px-1 py-1 cursor-pointer group border-r border-slate-100 hover:bg-slate-100"
                                >
                                    {day.tax.sum > 0 ? (
                                        <span className="font-medium text-red-800 block">
                                            {formatCurrency(day.tax.sum)}
                                        </span>
                                    ) : (
                                        <span className="opacity-0 group-hover:opacity-100 flex justify-center">
                                            <Plus className="w-4 h-4 text-slate-300" />
                                        </span>
                                    )}
                                </td>

                                {/* LOAN */}
                                <td 
                                    onClick={() => handleCellClick(day.dateStr, 'loan', day.loan.transactions)}
                                    className="px-1 py-1 cursor-pointer group border-r border-slate-100 hover:bg-slate-100"
                                >
                                    {day.loan.sum > 0 ? (
                                        <span className="font-medium text-orange-600 block">
                                            {formatCurrency(day.loan.sum)}
                                        </span>
                                    ) : (
                                        <span className="opacity-0 group-hover:opacity-100 flex justify-center">
                                            <Plus className="w-4 h-4 text-slate-300" />
                                        </span>
                                    )}
                                </td>

                                {/* PERSONAL */}
                                <td 
                                    onClick={() => handleCellClick(day.dateStr, 'personal', day.personal.transactions)}
                                    className="px-1 py-1 cursor-pointer group border-r border-slate-100 hover:bg-slate-100"
                                >
                                    {day.personal.sum > 0 ? (
                                        <span className="font-medium text-purple-600 block">
                                            {formatCurrency(day.personal.sum)}
                                        </span>
                                    ) : (
                                        <span className="opacity-0 group-hover:opacity-100 flex justify-center">
                                            <Plus className="w-4 h-4 text-slate-300" />
                                        </span>
                                    )}
                                </td>

                                {/* BALANCE */}
                                <td className={`px-2 py-2 font-bold border-r border-slate-200 text-xs ${day.balance < 0 ? 'text-red-600 bg-red-50' : 'text-slate-800'} ${isToday ? 'bg-blue-100' : 'bg-slate-50'}`}>
                                    {formatCurrency(day.balance)}
                                </td>
                            </tr>
                        )})}
                    </tbody>
                    {/* FOOTER ROW */}
                    <tfoot className="bg-slate-100 border-t-2 border-slate-300 text-xs sticky bottom-0 z-20 font-bold shadow-inner">
                        <tr>
                            <td className="px-2 py-3 text-right">סה"כ:</td>
                            
                            {/* FEE TOTALS */}
                            <td className="px-2 py-3 bg-emerald-100 border-r border-slate-300 text-emerald-900">
                                <div className="flex flex-col gap-1">
                                    <span>{formatCurrency(monthSummary.fee)}</span>
                                    <span className="text-[10px] text-emerald-700 border-t border-emerald-300 pt-1 mt-1">
                                        נטו (82%): {formatCurrency(monthSummary.fee * 0.82)}
                                    </span>
                                </div>
                            </td>
                            
                            <td className="px-2 py-3 text-emerald-700 border-r border-slate-300">{formatCurrency(monthSummary.otherIncome)}</td>
                            <td className="px-2 py-3 text-red-600 border-r border-slate-300">{formatCurrency(monthSummary.operational)}</td>
                            <td className="px-2 py-3 text-red-800 border-r border-slate-300">{formatCurrency(monthSummary.tax)}</td>
                            <td className="px-2 py-3 text-orange-600 border-r border-slate-300">{formatCurrency(monthSummary.loan)}</td>
                            <td className="px-2 py-3 text-purple-600 border-r border-slate-300">{formatCurrency(monthSummary.personal)}</td>
                            <td className="px-2 py-3 text-slate-800 border-r border-slate-300 bg-slate-200">
                                {formatCurrency(dailyData[dailyData.length-1]?.balance || 0)}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
      </div>
    </div>

    {selectedCell && (
      <DailyDetailModal 
        isOpen={detailModalOpen}
        onClose={() => { setDetailModalOpen(false); setSelectedCell(null); }}
        date={selectedCell.date}
        group={selectedCell.group}
        transactions={selectedCell.transactions}
        onDelete={(id) => {
            onDeleteTransaction(id);
            setDetailModalOpen(false); 
            setSelectedCell(null);
        }}
        onEdit={() => {}}
        onAdd={() => {
             setDetailModalOpen(false);
             const type = (selectedCell.group === 'fee' || selectedCell.group === 'other_income') ? 'income' : 'expense';
             openTransactionForm(selectedCell.date, type, selectedCell.group);
        }}
      />
    )}
    </>
  );
};

export default MonthlyFlow;"""

logo_tsx = r"""import React from 'react';

interface LogoProps {
  className?: string;
  collapsed?: boolean;
}

const Logo: React.FC<LogoProps> = ({ className = "", collapsed = false }) => {
  return (
    <div className={`flex flex-col items-center ${className}`}>
      {/* Icon / Monogram */}
      <div className="relative w-12 h-12 mb-2">
        <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
          {/* L Shape - Gold */}
          <path 
            d="M25 20 V80 H75" 
            fill="none" 
            stroke="#d4af37" 
            strokeWidth="8" 
            strokeLinecap="square"
          />
          {/* P Shape - Silver/Light Blue overlap */}
          <path 
            d="M25 20 H65 C75 20 80 30 80 40 C80 55 70 60 60 60 H25" 
            fill="none" 
            stroke="#94a3b8" 
            strokeWidth="8" 
            strokeLinecap="square"
            className="opacity-80"
          />
        </svg>
      </div>

      {/* Text */}
      {!collapsed && (
        <div className="text-center">
          <h1 className="text-xl font-bold tracking-wide text-[#d4af37] font-sans leading-none" style={{ fontFamily: 'Heebo, sans-serif' }}>
            Lior Perry
          </h1>
          <p className="text-[0.65rem] tracking-[0.2em] text-slate-300 mt-1 font-light uppercase">
            Law Office
          </p>
        </div>
      )}
    </div>
  );
};

export default Logo;"""

daily_detail_modal_tsx = r"""import React from 'react';
import { X, Trash2, Edit2, Plus } from 'lucide-react';
import { Transaction, TransactionGroup } from '../types';

interface DailyDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  date: string;
  group: TransactionGroup;
  transactions: Transaction[];
  onDelete: (id: string) => void;
  onEdit: (transaction: Transaction) => void; // Placeholder for future edit implementation
  onAdd: () => void;
}

const DailyDetailModal: React.FC<DailyDetailModalProps> = ({
  isOpen,
  onClose,
  date,
  group,
  transactions,
  onDelete,
  onEdit,
  onAdd
}) => {
  if (!isOpen) return null;

  const formattedDate = new Date(date).toLocaleDateString('he-IL', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });

  const getGroupTitle = (g: TransactionGroup) => {
    switch (g) {
      case 'fee': return 'שכר טרחה';
      case 'other_income': return 'הכנסות אחרות';
      case 'tax': return 'תשלומי מיסים';
      case 'loan': return 'הלוואות ומימון';
      case 'personal': return 'משיכות פרטיות';
      case 'operational': return 'הוצאות תפעול';
      default: return 'פרטים';
    }
  };

  const totalAmount = transactions.reduce((sum, t) => sum + t.amount, 0);
  const isIncome = group === 'fee' || group === 'other_income';

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh] border border-slate-200">
        
        {/* Header */}
        <div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-start">
          <div>
            <h3 className="text-lg font-bold text-slate-800">{getGroupTitle(group)}</h3>
            <p className="text-sm text-slate-500">{formattedDate}</p>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* List */}
        <div className="overflow-y-auto p-4 space-y-3 flex-1">
          {transactions.length === 0 ? (
            <p className="text-center text-slate-400 py-4">אין תנועות להצגה</p>
          ) : (
            transactions.map((t) => (
              <div key={t.id} className="bg-white border border-slate-100 rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow flex justify-between items-center group">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="font-bold text-slate-800 text-base">₪{t.amount.toLocaleString()}</span>
                    {t.clientReference && (
                      <span className="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">
                        #{t.clientReference}
                      </span>
                    )}
                  </div>
                  <p className="text-sm text-slate-600 font-medium">{t.description}</p>
                  <p className="text-xs text-slate-400">{t.category}</p>
                </div>
                
                <div className="flex gap-2 mr-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button 
                    onClick={() => onDelete(t.id)}
                    className="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors"
                    title="מחק"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t border-slate-100 bg-slate-50">
            <div className="flex justify-between items-center mb-4 px-1">
                <span className="font-medium text-slate-600">סה"כ ליום זה:</span>
                <span className={`font-bold text-lg ${isIncome ? 'text-emerald-600' : 'text-red-600'}`}>
                    ₪{totalAmount.toLocaleString()}
                </span>
            </div>
            <button 
                onClick={() => {
                    onAdd();
                }}
                className="w-full py-2.5 bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2"
            >
                <Plus className="w-4 h-4" />
                הוסף תנועה נוספת
            </button>
        </div>
      </div>
    </div>
  );
};

export default DailyDetailModal;"""

login_tsx = r"""import React, { useState } from 'react';
import Logo from './Logo';

interface LoginProps {
  onLogin: (user: string) => void;
}

const Login: React.FC<LoginProps> = ({ onLogin }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Hardcoded credentials as requested
    if ((username.toLowerCase() === 'lior' && password === 'lior123') ||
        (username.toLowerCase() === 'lidor' && password === 'lidor123')) {
      onLogin(username);
    } else {
      setError('שם משתמש או סיסמה שגויים');
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4" dir="rtl">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl border border-slate-100 p-8">
        <div className="flex justify-center mb-8">
          <Logo />
        </div>
        
        <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">כניסה למערכת</h2>
        <p className="text-center text-slate-500 mb-6 text-sm">ניהול תזרים - משרד עו"ד ליאור פרי</p>
        
        <form onSubmit={handleSubmit} className="space-y-5">
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">שם משתמש</label>
            <input
              type="text"
              value={username}
              onChange={(e) => { setUsername(e.target.value); setError(''); }}
              className="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-[#d4af37] focus:border-transparent outline-none transition-all bg-slate-50 focus:bg-white"
              placeholder="הזן שם משתמש"
              autoFocus
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">סיסמה</label>
            <input
              type="password"
              value={password}
              onChange={(e) => { setPassword(e.target.value); setError(''); }}
              className="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-[#d4af37] focus:border-transparent outline-none transition-all bg-slate-50 focus:bg-white"
              placeholder="הזן סיסמה"
            />
          </div>
          
          {error && (
            <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg text-center font-medium animate-pulse">
              {error}
            </div>
          )}
          
          <button
            type="submit"
            className="w-full py-3 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
          >
            התחבר
          </button>
        </form>
        
        <div className="mt-8 text-center text-xs text-slate-400">
          &copy; {new Date().getFullYear()} Lior Perry Law Office
        </div>
      </div>
    </div>
  );
};

export default Login;"""

financial_analysis_tsx = r"""import React, { useState, useMemo } from 'react';
import { Transaction } from '../types';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Calendar, Filter, Download, PieChart, BarChart3 } from 'lucide-react';

interface FinancialAnalysisProps {
  transactions: Transaction[];
  mode: 'income' | 'expense'; // Income analyzes Clients (description), Expense analyzes Categories
}

type TimeFrame = 'month' | 'quarter' | 'year';

const FinancialAnalysis: React.FC<FinancialAnalysisProps> = ({ transactions, mode }) => {
  const currentYear = new Date().getFullYear();
  const currentMonth = new Date().getMonth();
  
  const [timeFrame, setTimeFrame] = useState<TimeFrame>('month');
  const [selectedYear, setSelectedYear] = useState(currentYear);
  const [selectedMonth, setSelectedMonth] = useState(currentMonth); // 0-11
  const [selectedQuarter, setSelectedQuarter] = useState(Math.floor(currentMonth / 3) + 1); // 1-4

  // -- Helpers --
  const quarters = [
    { id: 1, label: 'רבעון 1 (ינו-מרץ)' },
    { id: 2, label: 'רבעון 2 (אפר-יוני)' },
    { id: 3, label: 'רבעון 3 (יולי-ספט)' },
    { id: 4, label: 'רבעון 4 (אוק-דצמ)' },
  ];

  const months = [
    'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
    'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
  ];

  // -- Filter Data --
  const filteredTransactions = useMemo(() => {
    return transactions.filter(t => {
      // 1. Filter by Type (Income vs Expense)
      if (t.type !== mode) return false;

      const tDate = new Date(t.date);
      const tYear = tDate.getFullYear();
      const tMonth = tDate.getMonth();

      // 2. Filter by Year
      if (tYear !== selectedYear) return false;

      // 3. Filter by TimeFrame
      if (timeFrame === 'month') {
        return tMonth === selectedMonth;
      } else if (timeFrame === 'quarter') {
        const tQuarter = Math.floor(tMonth / 3) + 1;
        return tQuarter === selectedQuarter;
      }
      
      // If 'year', we already filtered by year above
      return true;
    });
  }, [transactions, mode, timeFrame, selectedYear, selectedMonth, selectedQuarter]);

  // -- Aggregate Data --
  const aggregatedData = useMemo(() => {
    const grouped: Record<string, number> = {};
    let totalSum = 0;

    filteredTransactions.forEach(t => {
      // For Income -> Group by Client (Description field holds client name in this app flow)
      // For Expense -> Group by Category
      const key = mode === 'income' ? (t.description || 'ללא שם') : t.category;
      
      grouped[key] = (grouped[key] || 0) + t.amount;
      totalSum += t.amount;
    });

    // Convert to array for charts/tables
    const result = Object.entries(grouped)
      .map(([name, value]) => ({
        name,
        value,
        percentage: totalSum > 0 ? (value / totalSum) * 100 : 0
      }))
      .sort((a, b) => b.value - a.value); // Sort descending

    return { data: result, total: totalSum };
  }, [filteredTransactions, mode]);

  // -- Colors --
  const COLORS = mode === 'income' 
    ? ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#059669', '#047857'] // Greens
    : ['#ef4444', '#f87171', '#fca5a5', '#fecaca', '#b91c1c', '#991b1b']; // Reds

  return (
    <div className="space-y-6">
      {/* Controls Header */}
      <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
        
        <div className="flex items-center gap-2">
           <div className={`p-2 rounded-lg ${mode === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
             {mode === 'income' ? <PieChart className="w-6 h-6" /> : <BarChart3 className="w-6 h-6" />}
           </div>
           <h2 className="text-xl font-bold text-slate-800">
             {mode === 'income' ? 'פילוח הכנסות לפי לקוח' : 'פילוח הוצאות לפי קטגוריה'}
           </h2>
        </div>

        <div className="flex flex-wrap gap-2 items-center">
            {/* TimeFrame Selector */}
            <div className="flex bg-slate-100 p-1 rounded-lg">
                <button 
                    onClick={() => setTimeFrame('month')}
                    className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${timeFrame === 'month' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    חודשי
                </button>
                <button 
                    onClick={() => setTimeFrame('quarter')}
                    className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${timeFrame === 'quarter' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    רבעוני
                </button>
                <button 
                    onClick={() => setTimeFrame('year')}
                    className={`px-3 py-1 text-sm font-medium rounded-md transition-all ${timeFrame === 'year' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    שנתי
                </button>
            </div>

            {/* Year Selector */}
            <select 
                value={selectedYear} 
                onChange={(e) => setSelectedYear(Number(e.target.value))}
                className="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2"
            >
                {[currentYear - 1, currentYear, currentYear + 1].map(y => (
                    <option key={y} value={y}>{y}</option>
                ))}
            </select>

            {/* Conditional Selectors */}
            {timeFrame === 'month' && (
                <select 
                    value={selectedMonth} 
                    onChange={(e) => setSelectedMonth(Number(e.target.value))}
                    className="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2"
                >
                    {months.map((m, idx) => (
                        <option key={idx} value={idx}>{m}</option>
                    ))}
                </select>
            )}

            {timeFrame === 'quarter' && (
                <select 
                    value={selectedQuarter} 
                    onChange={(e) => setSelectedQuarter(Number(e.target.value))}
                    className="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2"
                >
                    {quarters.map(q => (
                        <option key={q.id} value={q.id}>{q.label}</option>
                    ))}
                </select>
            )}
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
         {/* Total Card */}
         <div className={`p-6 rounded-xl shadow-sm border border-slate-100 text-white ${mode === 'income' ? 'bg-emerald-600' : 'bg-red-600'}`}>
            <p className="text-emerald-100 text-sm font-medium mb-1 opacity-80">סה"כ {mode === 'income' ? 'הכנסות' : 'הוצאות'} לתקופה</p>
            <p className="text-3xl font-bold">₪{aggregatedData.total.toLocaleString()}</p>
         </div>
         
         {/* Top Item Card */}
         <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
             <p className="text-slate-500 text-sm font-medium mb-1">
                 {mode === 'income' ? 'הלקוח המוביל' : 'הקטגוריה הגדולה ביותר'}
             </p>
             {aggregatedData.data.length > 0 ? (
                 <div>
                     <p className="text-2xl font-bold text-slate-800">{aggregatedData.data[0].name}</p>
                     <p className="text-sm text-slate-400">₪{aggregatedData.data[0].value.toLocaleString()}</p>
                 </div>
             ) : (
                 <p className="text-slate-400 italic">אין נתונים</p>
             )}
         </div>

         {/* Count Card */}
         <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
             <p className="text-slate-500 text-sm font-medium mb-1">מספר {mode === 'income' ? 'לקוחות פעילים' : 'קטגוריות פעילות'}</p>
             <p className="text-3xl font-bold text-slate-800">{aggregatedData.data.length}</p>
         </div>
      </div>

      {/* Chart & Table Layout */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          {/* Chart */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[400px]">
              <h3 className="text-lg font-bold text-slate-800 mb-6">תצוגה גרפית</h3>
              {aggregatedData.data.length > 0 ? (
                  <ResponsiveContainer width="100%" height={300}>
                      <BarChart data={aggregatedData.data.slice(0, 10)} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                          <XAxis type="number" hide />
                          <YAxis 
                            dataKey="name" 
                            type="category" 
                            width={100} 
                            tick={{fontSize: 11, fill: '#64748b'}} 
                            interval={0}
                          />
                          <Tooltip 
                             cursor={{fill: '#f1f5f9'}}
                             formatter={(value: number) => `₪${value.toLocaleString()}`}
                             contentStyle={{ borderRadius: '8px', direction: 'rtl' }}
                          />
                          <Bar dataKey="value" radius={[0, 4, 4, 0]}>
                             {aggregatedData.data.slice(0, 10).map((entry, index) => (
                                 <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                             ))}
                          </Bar>
                      </BarChart>
                  </ResponsiveContainer>
              ) : (
                  <div className="h-full flex items-center justify-center text-slate-400">
                      אין נתונים להצגה בתקופה שנבחרה
                  </div>
              )}
          </div>

          {/* Table */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-6 border-b border-slate-100">
                  <h3 className="text-lg font-bold text-slate-800">פירוט מלא</h3>
              </div>
              <div className="overflow-x-auto">
                  <table className="w-full text-sm text-right">
                      <thead className="bg-slate-50 text-slate-500 font-medium">
                          <tr>
                              <th className="px-6 py-3">{mode === 'income' ? 'שם לקוח' : 'קטגוריה'}</th>
                              <th className="px-6 py-3">סכום</th>
                              <th className="px-6 py-3">% מסה"כ</th>
                          </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-50">
                          {aggregatedData.data.map((item, idx) => (
                              <tr key={idx} className="hover:bg-slate-50">
                                  <td className="px-6 py-3 font-medium text-slate-700">{item.name}</td>
                                  <td className="px-6 py-3 font-bold text-slate-800">₪{item.value.toLocaleString()}</td>
                                  <td className="px-6 py-3 text-slate-500">
                                      <div className="flex items-center gap-2">
                                          <div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                              <div 
                                                className={`h-full rounded-full ${mode === 'income' ? 'bg-emerald-500' : 'bg-red-500'}`} 
                                                style={{ width: `${item.percentage}%` }}
                                              ></div>
                                          </div>
                                          {item.percentage.toFixed(1)}%
                                      </div>
                                  </td>
                              </tr>
                          ))}
                          {aggregatedData.data.length === 0 && (
                              <tr>
                                  <td colSpan={3} className="px-6 py-10 text-center text-slate-400">
                                      לא נמצאו נתונים
                                  </td>
                              </tr>
                          )}
                      </tbody>
                  </table>
              </div>
          </div>

      </div>
    </div>
  );
};

export default FinancialAnalysis;"""

collection_tracker_tsx = r"""import React, { useMemo } from 'react';
import { Transaction } from '../types';
import { AlertCircle, CheckCircle, DollarSign, Calendar } from 'lucide-react';

interface CollectionTrackerProps {
  transactions: Transaction[];
  onMarkAsPaid: (transaction: Transaction) => void;
}

const CollectionTracker: React.FC<CollectionTrackerProps> = ({ transactions, onMarkAsPaid }) => {
  
  // Filter: Income -> Pending -> Only "Sh'char Tircha" (Fee)
  const pendingFees = useMemo(() => {
    return transactions
      .filter(t => 
          t.type === 'income' && 
          t.status === 'pending' && 
          t.category === 'שכר טרחה' // Strict filter as requested
      )
      .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  }, [transactions]);

  const calculateDaysOpen = (dateStr: string) => {
    const start = new Date(dateStr);
    const now = new Date();
    const diff = now.getTime() - start.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  };

  const totalPending = pendingFees.reduce((sum, t) => sum + t.amount, 0);
  const overdueCount = pendingFees.filter(t => calculateDaysOpen(t.date) > 30).length;

  return (
    <div className="space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
           <div>
             <p className="text-sm text-slate-500 font-medium">צפי גבייה (שכ"ט בלבד)</p>
             <p className="text-2xl font-bold text-slate-800">₪{totalPending.toLocaleString()}</p>
           </div>
           <div className="p-3 bg-blue-50 rounded-full">
             <DollarSign className="w-6 h-6 text-blue-600" />
           </div>
        </div>

        <div className={`p-6 rounded-xl shadow-sm border flex items-center justify-between ${overdueCount > 0 ? 'bg-red-50 border-red-100' : 'bg-emerald-50 border-emerald-100'}`}>
           <div>
             <p className={`text-sm font-medium ${overdueCount > 0 ? 'text-red-600' : 'text-emerald-600'}`}>
               חשבונות בפיגור (>30 יום)
             </p>
             <p className={`text-2xl font-bold ${overdueCount > 0 ? 'text-red-700' : 'text-emerald-700'}`}>
               {overdueCount}
             </p>
           </div>
           <div className={`p-3 rounded-full ${overdueCount > 0 ? 'bg-red-100' : 'bg-emerald-100'}`}>
             <AlertCircle className={`w-6 h-6 ${overdueCount > 0 ? 'text-red-600' : 'text-emerald-600'}`} />
           </div>
        </div>
      </div>

      {/* Aging Table */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="p-6 border-b border-slate-100 bg-slate-50/50">
          <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
            <Calendar className="w-5 h-5 text-blue-600" />
            מעקב גבייה (Aging Report)
          </h3>
          <p className="text-sm text-slate-500 mt-1">
            רשימת דרישות תשלום/חשבונות עסקה פתוחים (שכר טרחה בלבד). שורות אדומות מסמנות פיגור של מעל 30 יום.
          </p>
        </div>
        
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-right">
            <thead className="bg-slate-100 text-slate-600 font-bold">
              <tr>
                <th className="px-6 py-4">תאריך דרישה</th>
                <th className="px-6 py-4">לקוח</th>
                <th className="px-6 py-4">אסמכתא/תיק</th>
                <th className="px-6 py-4">סכום לתשלום</th>
                <th className="px-6 py-4">ימים פתוח</th>
                <th className="px-6 py-4">פעולות</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {pendingFees.length === 0 ? (
                <tr>
                  <td colSpan={6} className="px-6 py-12 text-center text-slate-400">
                    <div className="flex flex-col items-center gap-2">
                        <CheckCircle className="w-10 h-10 text-emerald-400" />
                        <span className="text-lg font-medium text-slate-600">אין חובות פתוחים</span>
                        <span>כל דרישות שכר הטרחה שולמו במלואן.</span>
                    </div>
                  </td>
                </tr>
              ) : (
                pendingFees.map((t) => {
                  const daysOpen = calculateDaysOpen(t.date);
                  const isOverdue = daysOpen > 30;
                  
                  return (
                    <tr key={t.id} className={`transition-all ${isOverdue ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-slate-50'}`}>
                      <td className="px-6 py-4 font-medium text-slate-700">
                        {new Date(t.date).toLocaleDateString('he-IL')}
                      </td>
                      <td className="px-6 py-4 text-slate-900 font-bold text-base">{t.description}</td>
                      <td className="px-6 py-4 text-slate-500">
                          {t.clientReference ? (
                             <span className="bg-white border border-slate-200 px-2 py-1 rounded text-xs">#{t.clientReference}</span>
                          ) : '-'}
                      </td>
                      <td className="px-6 py-4 font-bold text-slate-800">₪{t.amount.toLocaleString()}</td>
                      <td className="px-6 py-4">
                        <div className="flex items-center gap-2">
                            <span className={`px-2 py-1 rounded text-xs font-bold ${isOverdue ? 'bg-red-200 text-red-800' : 'bg-slate-200 text-slate-700'}`}>
                            {daysOpen} ימים
                            </span>
                            {isOverdue && <AlertCircle className="w-4 h-4 text-red-600" />}
                        </div>
                      </td>
                      <td className="px-6 py-4">
                        <button 
                          onClick={() => onMarkAsPaid(t)}
                          className="text-xs bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm font-medium"
                        >
                          סמן כשולם
                        </button>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

export default CollectionTracker;"""

executive_summary_tsx = r"""import React, { useState } from 'react';
import { Transaction } from '../types';
import { generateExecutiveSummary } from '../services/reportService';
import { FileText, Copy, Check, Sparkles } from 'lucide-react';

interface ExecutiveSummaryProps {
  transactions: Transaction[];
}

const ExecutiveSummary: React.FC<ExecutiveSummaryProps> = ({ transactions }) => {
  const [reportText, setReportText] = useState<string>('');
  const [currentPeriod, setCurrentPeriod] = useState<'month' | 'quarter' | 'year' | null>(null);
  const [copied, setCopied] = useState(false);

  const handleGenerate = (period: 'month' | 'quarter' | 'year') => {
    setCurrentPeriod(period);
    const text = generateExecutiveSummary(period, transactions);
    setReportText(text);
    setCopied(false);
  };

  const handleCopy = () => {
    navigator.clipboard.writeText(reportText);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="space-y-8 max-w-5xl mx-auto">
      <div className="text-center space-y-2">
        <h2 className="text-3xl font-bold text-slate-800">תקציר מנהלים</h2>
        <p className="text-slate-500">בחר את טווח הזמן הרצוי לקבלת דוח מילולי מקיף על מצב המשרד</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <button 
          onClick={() => handleGenerate('month')}
          className={`relative overflow-hidden p-8 rounded-2xl border-2 transition-all group ${currentPeriod === 'month' ? 'border-blue-600 bg-blue-50 shadow-lg' : 'border-slate-200 bg-white hover:border-blue-400 hover:shadow-md'}`}
        >
          <div className="absolute top-0 left-0 w-full h-1 bg-blue-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
          <FileText className={`w-10 h-10 mb-4 ${currentPeriod === 'month' ? 'text-blue-600' : 'text-slate-400 group-hover:text-blue-500'}`} />
          <span className="block text-xl font-bold text-slate-800 mb-2">סיכום חודשי</span>
          <span className="text-sm text-slate-500">כתוב לי סיכום מנהלים חודשי</span>
        </button>

        <button 
          onClick={() => handleGenerate('quarter')}
          className={`relative overflow-hidden p-8 rounded-2xl border-2 transition-all group ${currentPeriod === 'quarter' ? 'border-blue-600 bg-blue-50 shadow-lg' : 'border-slate-200 bg-white hover:border-blue-400 hover:shadow-md'}`}
        >
          <div className="absolute top-0 left-0 w-full h-1 bg-blue-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
          <FileText className={`w-10 h-10 mb-4 ${currentPeriod === 'quarter' ? 'text-blue-600' : 'text-slate-400 group-hover:text-blue-500'}`} />
          <span className="block text-xl font-bold text-slate-800 mb-2">סיכום רבעוני</span>
          <span className="text-sm text-slate-500">כתוב לי סיכום מנהלים רבעוני</span>
        </button>

        <button 
          onClick={() => handleGenerate('year')}
          className={`relative overflow-hidden p-8 rounded-2xl border-2 transition-all group ${currentPeriod === 'year' ? 'border-blue-600 bg-blue-50 shadow-lg' : 'border-slate-200 bg-white hover:border-blue-400 hover:shadow-md'}`}
        >
          <div className="absolute top-0 left-0 w-full h-1 bg-blue-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
          <Sparkles className={`w-10 h-10 mb-4 ${currentPeriod === 'year' ? 'text-blue-600' : 'text-slate-400 group-hover:text-blue-500'}`} />
          <span className="block text-xl font-bold text-slate-800 mb-2">סיכום שנתי</span>
          <span className="text-sm text-slate-500">כתוב לי סיכום מנהלים שנתי</span>
        </button>
      </div>

      {reportText && (
        <div className="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden animate-fade-in-up">
          <div className="bg-slate-900 px-6 py-3 flex justify-between items-center text-white">
            <div className="flex items-center gap-2">
                <Sparkles className="w-4 h-4 text-[#d4af37]" />
                <span className="text-sm font-bold tracking-wider">דוח נוצר בהצלחה</span>
            </div>
            <button 
              onClick={handleCopy}
              className="flex items-center gap-2 px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs font-medium transition-colors border border-slate-700"
            >
              {copied ? <Check className="w-3 h-3 text-green-400" /> : <Copy className="w-3 h-3" />}
              {copied ? 'הועתק ללוח' : 'העתק טקסט'}
            </button>
          </div>
          <div className="p-8 bg-slate-50">
            <div className="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <pre className="whitespace-pre-wrap font-sans text-base text-slate-800 leading-loose">
                {reportText}
                </pre>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default ExecutiveSummary;"""

# --- WRITE FILES ---

create_file("index.html", index_html)
create_file("index.tsx", index_tsx)
create_file("metadata.json", metadata_json)
create_file("types.ts", types_ts)
create_file("constants.ts", constants_ts)

create_file("services/storageService.ts", storage_service_ts)
create_file("services/reportService.ts", report_service_ts)
create_file("services/taxService.ts", tax_service_ts)

create_file("components/Dashboard.tsx", dashboard_tsx)
create_file("components/TransactionForm.tsx", transaction_form_tsx)
create_file("components/TransactionList.tsx", transaction_list_tsx)
create_file("App.tsx", app_tsx)
create_file("components/MonthlyFlow.tsx", monthly_flow_tsx)
create_file("components/Logo.tsx", logo_tsx)
create_file("components/DailyDetailModal.tsx", daily_detail_modal_tsx)
create_file("components/Login.tsx", login_tsx)
create_file("components/FinancialAnalysis.tsx", financial_analysis_tsx)
create_file("components/CollectionTracker.tsx", collection_tracker_tsx)
create_file("components/ExecutiveSummary.tsx", executive_summary_tsx)

print("\nAll files have been successfully updated and saved!")